grammar LengthGrammar

  rule term
    number_set | arithmetic
  end

  rule number_set
    (mixed_number space* term){
      capture(:mixed_number).value + capture(:term).value
    }
  end

  rule arithmetic
    additive | factor
  end

  rule additive
    (factor operator:('+' | '-') space* term) {
      capture(:factor).value.send(capture(:operator).to_s, capture(:term).value)
    }
  end

  rule factor
    multiplicative | prefix 
  end

  rule multiplicative
    (prefix operator:('*' | '/' | '%') space* factor) {
      capture(:prefix).value.send(capture(:operator).to_s, capture(:factor).value)
    }
  end

  rule prefix
    prefixed | exponent
  end

  rule prefixed
    (operator:('-' | '+' | '~') space* prefix) {
      s = capture(:operator).to_s
      s += '@' unless s == '~' # Unary + and - require an @.
      capture(:prefix).value.send(s)
    }
  end

  rule exponent
    exponential | primary
  end

  rule exponential
    (primary operator:'**' space* prefix) {
      capture(:primary).value.send(capture(:operator).to_s, capture(:prefix).value)
    }
  end

  rule primary
    group | mixed_number
  end

  rule group
    (lparen term rparen) {
      capture(:term).value
    }
  end

  ## Lexical syntax

  rule mixed_number
    formatted_number | number
  end

  rule number
    irrational | integer
  end

  rule irrational
    rational | float 
  end

  rule float
    decimal | integer
  end

  rule decimal
    (digits '.' integer) { to_str.to_f }
  end

  rule integer
    (digits space*) { capture(:digits).to_str.to_i }
  end

  rule rational
    (float '/' float) { to_str.to_r }
  end

  rule formatted_number
    feet | inches | cm | mm | meter
  end

  rule inches
    (number inch_identifier space*){
      capture(:number).value
    }
  end

  rule feet
    (number foot_identifier space*) {
      capture(:number).value * 12
    }
  end

  rule mm
    (number mm_identifier space*){
      (capture(:number).value * 0.0393701).round(4)
    }
  end

  rule cm
    (number cm_identifier space*){
      (capture(:number).value * 0.393701).round(4)
    }
  end

  rule meter
    (number meter_identifier space*){
      (capture(:number).value * 39.3701).round(4)
    }
  end

  rule cm_identifier
    'cm' | 'centimeters' | 'centimetres'
  end

  rule mm_identifier
    'mm' | 'millimeters' | 'millimetres'
  end

  rule foot_identifier 
    '\'' | 'feet' | 'ft' | "'" | "\'"
  end

  rule inch_identifier 
    '\"' | 'inches' | 'in' | '"' | '\"'
  end

  rule meter_identifier
    'meter' | 'meters' | 'm'
  end

  rule digits
    [0-9]+ ('_' [0-9]+)* # mixed_numbers may contain underscores.
  end

  rule lparen '(' space* end
  rule rparen ')' space* end
  rule space  [ \t\n\r]  end
end